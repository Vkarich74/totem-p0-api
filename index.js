import express from "express";
import cors from "cors";
import db from "./db.js";
import ownerRoutes from "./routes_owner/index.js";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// ===== HEALTH =====
app.get("/health", (req, res) => res.json({ ok: true }));

// ===== OWNER =====
app.use("/owner", ownerRoutes);

// ===== ENSURE SALONS =====
async function ensureSalonsTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        slug TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'active',
        created_at TIMESTAMPTZ DEFAULT now(),
        updated_at TIMESTAMPTZ DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        slug TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'active',
        created_at TEXT DEFAULT (datetime('now')),
        updated_at TEXT DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== ENSURE FINANCE =====
async function ensureFinanceTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id BIGSERIAL PRIMARY KEY,
        salon_id TEXT NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TIMESTAMPTZ DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        salon_id TEXT NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TEXT DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== FINANCE CREATE =====
app.post("/finance/event", async (req, res) => {
  const { salon_id, master_id, type, amount } = req.body;
  if (!salon_id || !type || !amount)
    return res.status(400).json({ error: "INVALID_INPUT" });

  const sql =
    db.mode === "POSTGRES"
      ? `INSERT INTO finance_events
         (salon_id, master_id, type, amount, status)
         VALUES ($1,$2,$3,$4,'confirmed')`
      : `INSERT INTO finance_events
         (salon_id, master_id, type, amount, status)
         VALUES (?,?,?,?, 'confirmed')`;

  await db.run(sql, [salon_id, master_id || null, type, amount]);
  res.json({ ok: true });
});

// ===== FINANCE READ BY SALON =====
app.get("/finance/salon/:salon_id", async (req, res) => {
  const sql =
    db.mode === "POSTGRES"
      ? `SELECT * FROM finance_events WHERE salon_id=$1 ORDER BY created_at DESC`
      : `SELECT * FROM finance_events WHERE salon_id=? ORDER BY created_at DESC`;

  const rows = await db.all(sql, [req.params.salon_id]);
  res.json({ ok: true, items: rows });
});

// ===== SALON AUTO RESOLVE =====
app.use("/s/:slug", async (req, res, next) => {
  const slug = req.params.slug;

  const select =
    db.mode === "POSTGRES"
      ? "SELECT * FROM salons WHERE slug=$1"
      : "SELECT * FROM salons WHERE slug=?";

  let salon = await db.get(select, [slug]);

  if (!salon) {
    const insert =
      db.mode === "POSTGRES"
        ? `INSERT INTO salons (slug,name,status)
           VALUES ($1,$2,'active')
           ON CONFLICT (slug) DO NOTHING
           RETURNING *`
        : `INSERT OR IGNORE INTO salons (slug,name,status)
           VALUES (?,?, 'active')`;

    if (db.mode === "POSTGRES") salon = await db.get(insert, [slug, slug]);
    else {
      await db.run(insert, [slug, slug]);
      salon = await db.get(select, [slug]);
    }
  }

  req.salon = salon;
  req.salon_id = salon.id;
  next();
});

// ===== START =====
async function bootstrap() {
  await ensureSalonsTable();
  await ensureFinanceTable();

  app.listen(PORT, () => {
    console.log("TOTEM API STARTED", PORT);
  });
}

bootstrap().catch((e) => {
  console.error(e);
  process.exit(1);
});
