import express from "express";
import cors from "cors";
import db from "./db.js";
import ownerRoutes from "./routes_owner/index.js";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// ===== HEALTH =====
app.get("/health", (_req, res) => res.json({ ok: true }));

// ===== ENSURE SALONS =====
async function ensureSalonsTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        slug TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'created',
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        slug TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'created',
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        updated_at TEXT NOT NULL DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== ENSURE FINANCE =====
// ВАЖНО: salon_id = TEXT (мы уже писали туда "s1", "s2" в проде)
async function ensureFinanceTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id BIGSERIAL PRIMARY KEY,
        salon_id TEXT NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TIMESTAMPTZ NOT NULL DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        salon_id TEXT NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TEXT NOT NULL DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== ENSURE SUBSCRIPTIONS =====
// ВАЖНО: salon_id = TEXT (активация от "s1"/"s2" без перелома данных)
async function ensureSubscriptionsTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salon_subscriptions (
        salon_id TEXT PRIMARY KEY,
        active_until TIMESTAMPTZ NOT NULL
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salon_subscriptions (
        salon_id TEXT PRIMARY KEY,
        active_until TEXT NOT NULL
      );
    `);
  }
}

// ===== ACTIVATION GUARD (SUBSCRIPTION) =====
async function requireActiveSalon(req, res, next) {
  const salon_id =
    req.headers["x-salon-id"] ||
    req.body?.salon_id ||
    req.params?.salon_id;

  if (!salon_id) return res.status(400).json({ error: "SALON_ID_REQUIRED" });

  const sql =
    db.mode === "POSTGRES"
      ? `SELECT 1 FROM salon_subscriptions
         WHERE salon_id=$1 AND active_until >= NOW()`
      : `SELECT 1 FROM salon_subscriptions
         WHERE salon_id=? AND active_until >= datetime('now')`;

  const row = await db.get(sql, [String(salon_id)]);
  if (!row) return res.status(403).json({ error: "SALON_NOT_ACTIVE" });

  next();
}

// ===== SALON CONTEXT RESOLVER (AUTO-CREATE) =====
app.use("/s/:slug", async (req, res, next) => {
  try {
    const slug = req.params.slug;

    const selectSql =
      db.mode === "POSTGRES"
        ? "SELECT id, slug, status FROM salons WHERE slug = $1"
        : "SELECT id, slug, status FROM salons WHERE slug = ?";

    let salon = await db.get(selectSql, [slug]);

    // AUTO-CREATE IF NOT EXISTS
    if (!salon) {
      const insertSql =
        db.mode === "POSTGRES"
          ? `
            INSERT INTO salons (slug, name, status)
            VALUES ($1, $2, 'created')
            ON CONFLICT (slug) DO NOTHING
            RETURNING id, slug, status;
          `
          : `
            INSERT OR IGNORE INTO salons (slug, name, status)
            VALUES (?, ?, 'created');
          `;

      if (db.mode === "POSTGRES") {
        salon = await db.get(insertSql, [slug, slug]);
      } else {
        await db.run(insertSql, [slug, slug]);
        salon = await db.get(selectSql, [slug]);
      }
    }

    if (!salon) return res.status(500).json({ error: "SALON_CREATE_FAILED" });

    req.salon = salon;
    req.salon_id = salon.id;
    next();
  } catch (e) {
    console.error("[SALON_RESOLVER]", e);
    res.status(500).json({ error: "SALON_RESOLVE_FAILED" });
  }
});

// ===== RESOLVE API (PUBLIC) =====
app.get("/s/:slug/resolve", (req, res) => {
  res.json({
    ok: true,
    salon_id: String(req.salon_id),
    slug: req.salon.slug,
    status: req.salon.status
  });
});

// ===== OWNER (GUARDED) =====
app.use("/owner", requireActiveSalon, ownerRoutes);

// ===== FINANCE READ (GUARDED) =====
app.get("/finance/salon/:salon_id", requireActiveSalon, async (req, res) => {
  const sql =
    db.mode === "POSTGRES"
      ? `SELECT * FROM finance_events WHERE salon_id=$1 ORDER BY created_at DESC`
      : `SELECT * FROM finance_events WHERE salon_id=? ORDER BY created_at DESC`;

  const rows = await db.all(sql, [String(req.params.salon_id)]);
  res.json({ ok: true, items: rows });
});

// ===== PAYMENT -> EXTEND SUBSCRIPTION =====
app.post("/finance/event", async (req, res) => {
  try {
    const { salon_id, type, amount } = req.body;
    if (!salon_id || !type || !amount) {
      return res.status(400).json({ error: "INVALID_INPUT" });
    }

    const insertPay =
      db.mode === "POSTGRES"
        ? `INSERT INTO finance_events (salon_id,type,amount,status)
           VALUES ($1,$2,$3,'confirmed')`
        : `INSERT INTO finance_events (salon_id,type,amount,status)
           VALUES (?,?,?,'confirmed')`;

    await db.run(insertPay, [String(salon_id), type, amount]);

    const extend =
      db.mode === "POSTGRES"
        ? `
          INSERT INTO salon_subscriptions (salon_id, active_until)
          VALUES ($1, NOW() + INTERVAL '30 days')
          ON CONFLICT (salon_id)
          DO UPDATE SET active_until =
            GREATEST(salon_subscriptions.active_until, NOW())
            + INTERVAL '30 days'
        `
        : `
          INSERT INTO salon_subscriptions (salon_id, active_until)
          VALUES (?, datetime('now','+30 days'))
          ON CONFLICT(salon_id)
          DO UPDATE SET active_until =
            datetime(MAX(active_until, datetime('now')), '+30 days')
        `;

    await db.run(extend, [String(salon_id)]);
    res.json({ ok: true });
  } catch (e) {
    console.error("[FINANCE_EVENT]", e);
    res.status(500).json({ error: "FINANCE_EVENT_FAILED" });
  }
});

// ===== START =====
async function bootstrap() {
  await ensureSalonsTable();
  await ensureFinanceTable();
  await ensureSubscriptionsTable();

  app.listen(PORT, () => {
    console.log("TOTEM API STARTED", PORT);
  });
}

bootstrap().catch((e) => {
  console.error("[BOOTSTRAP_FAILED]", e);
  process.exit(1);
});
