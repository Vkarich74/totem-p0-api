import express from "express";
import cors from "cors";
import db from "./db.js";
import ownerRoutes from "./routes_owner/index.js";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// ===== HEALTH =====
app.get("/health", (_req, res) => res.json({ ok: true }));

// ===== ENSURE SALONS =====
async function ensureSalonsTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        slug TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'created',
        created_at TIMESTAMPTZ DEFAULT now(),
        updated_at TIMESTAMPTZ DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salons (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        slug TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'created',
        created_at TEXT DEFAULT (datetime('now')),
        updated_at TEXT DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== ENSURE OWNER_SALON (SLUG → ID MIGRATION) =====
async function ensureOwnerSalonTable() {
  if (db.mode !== "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS owner_salon (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        owner_id TEXT NOT NULL,
        salon_id INTEGER NOT NULL,
        status TEXT NOT NULL DEFAULT 'active',
        created_at TEXT DEFAULT (datetime('now'))
      );
    `);
    await db.run(`
      CREATE UNIQUE INDEX IF NOT EXISTS ux_owner_salon
      ON owner_salon (owner_id, salon_id);
    `);
    return;
  }

  const col = await db.get(`
    SELECT data_type
    FROM information_schema.columns
    WHERE table_name='owner_salon'
      AND column_name='salon_id'
  `);

  if (!col) {
    await db.run(`
      CREATE TABLE owner_salon (
        id BIGSERIAL PRIMARY KEY,
        owner_id TEXT NOT NULL,
        salon_id BIGINT NOT NULL,
        status TEXT NOT NULL DEFAULT 'active',
        created_at TIMESTAMPTZ DEFAULT now()
      );
    `);
    await db.run(`
      CREATE UNIQUE INDEX ux_owner_salon
      ON owner_salon (owner_id, salon_id);
    `);
    return;
  }

  if (col.data_type === "bigint") return;

  console.log("[MIGRATION] owner_salon.salon_id SLUG -> salons.id");

  await db.run(`DROP TABLE IF EXISTS owner_salon_new;`);

  await db.run(`
    CREATE TABLE owner_salon_new (
      id BIGSERIAL PRIMARY KEY,
      owner_id TEXT NOT NULL,
      salon_id BIGINT NOT NULL,
      status TEXT NOT NULL DEFAULT 'active',
      created_at TIMESTAMPTZ DEFAULT now()
    );
  `);

  // КЛЮЧЕВОЙ ФИКС: JOIN ПО SLUG
  await db.run(`
    INSERT INTO owner_salon_new (owner_id, salon_id, status, created_at)
    SELECT os.owner_id, s.id, os.status, os.created_at
    FROM owner_salon os
    JOIN salons s ON s.slug = os.salon_id
  `);

  await db.run(`DROP TABLE owner_salon;`);
  await db.run(`ALTER TABLE owner_salon_new RENAME TO owner_salon;`);

  await db.run(`
    CREATE UNIQUE INDEX ux_owner_salon
    ON owner_salon (owner_id, salon_id);
  `);

  console.log("[MIGRATION] owner_salon FIXED VIA SLUG");
}

// ===== ENSURE FINANCE =====
async function ensureFinanceTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id BIGSERIAL PRIMARY KEY,
        salon_id BIGINT NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TIMESTAMPTZ DEFAULT now()
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS finance_events (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        salon_id INTEGER NOT NULL,
        master_id TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        amount INTEGER NOT NULL,
        currency TEXT NOT NULL DEFAULT 'KGS',
        created_at TEXT DEFAULT (datetime('now'))
      );
    `);
  }
}

// ===== ENSURE SUBSCRIPTIONS =====
async function ensureSubscriptionsTable() {
  if (db.mode === "POSTGRES") {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salon_subscriptions (
        salon_id BIGINT PRIMARY KEY,
        active_until TIMESTAMPTZ NOT NULL
      );
    `);
  } else {
    await db.run(`
      CREATE TABLE IF NOT EXISTS salon_subscriptions (
        salon_id INTEGER PRIMARY KEY,
        active_until TEXT NOT NULL
      );
    `);
  }
}

// ===== START =====
async function bootstrap() {
  await ensureSalonsTable();
  await ensureOwnerSalonTable();
  await ensureFinanceTable();
  await ensureSubscriptionsTable();

  app.use("/owner", ownerRoutes);

  app.listen(PORT, () => {
    console.log("TOTEM API STARTED", PORT);
  });
}

bootstrap().catch((e) => {
  console.error(e);
  process.exit(1);
});
