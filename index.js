import express from "express";
import cors from "cors";
import db from "./db.js";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// ===== HEALTH =====
app.get("/health", (req, res) => res.json({ ok: true }));

// ===== ADMIN: ONE-TIME SEED SALONS =====
app.post("/_admin/seed-salons", async (req, res) => {
  try {
    // ensure table (PG + SQLITE)
    const createSql =
      db.mode === "POSTGRES"
        ? `
          CREATE TABLE IF NOT EXISTS salons (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            slug TEXT NOT NULL UNIQUE,
            name TEXT NOT NULL,
            status TEXT NOT NULL DEFAULT 'active',
            created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
            updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
          );
        `
        : `
          CREATE TABLE IF NOT EXISTS salons (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            slug TEXT NOT NULL UNIQUE,
            name TEXT NOT NULL,
            status TEXT NOT NULL DEFAULT 'active',
            created_at TEXT NOT NULL DEFAULT (datetime('now')),
            updated_at TEXT NOT NULL DEFAULT (datetime('now'))
          );
        `;
    await db.run(createSql);

    // seed (idempotent)
    const seedSql =
      db.mode === "POSTGRES"
        ? `
          INSERT INTO salons (id, slug, name, status) VALUES
            (1,'salon-1','Salon 1','active'),
            (2,'salon-2','Salon 2','active'),
            (3,'salon-3','Salon 3','active'),
            (4,'salon-4','Salon 4','active'),
            (5,'salon-5','Salon 5','active')
          ON CONFLICT (id) DO NOTHING;
        `
        : `
          INSERT OR IGNORE INTO salons (id, slug, name, status) VALUES
            (1,'salon-1','Salon 1','active'),
            (2,'salon-2','Salon 2','active'),
            (3,'salon-3','Salon 3','active'),
            (4,'salon-4','Salon 4','active'),
            (5,'salon-5','Salon 5','active');
        `;
    await db.run(seedSql);

    res.json({ ok: true, seeded: 5 });
  } catch (e) {
    console.error("[ADMIN SEED ERROR]", e);
    res.status(500).json({ error: "SEED_FAILED" });
  }
});

// ===== SALON CONTEXT RESOLVER =====
app.use("/s/:slug", async (req, res, next) => {
  try {
    const sql =
      db.mode === "POSTGRES"
        ? "SELECT id, slug, status FROM salons WHERE slug = $1"
        : "SELECT id, slug, status FROM salons WHERE slug = ?";

    const salon = await db.get(sql, [req.params.slug]);
    if (!salon) return res.status(404).json({ error: "SALON_NOT_FOUND" });
    if (salon.status !== "active")
      return res.status(403).json({ error: "SALON_INACTIVE" });

    req.salon = salon;
    req.salon_id = salon.id;
    next();
  } catch (e) {
    console.error("[SALON RESOLVE]", e);
    res.status(500).json({ error: "SALON_RESOLVE_FAILED" });
  }
});

// ===== RESOLVE =====
app.get("/s/:slug/resolve", (req, res) => {
  res.json({ ok: true, salon_id: String(req.salon_id), slug: req.salon.slug });
});

// ===== START =====
app.listen(PORT, () => console.log(`TOTEM API running on port ${PORT}`));
