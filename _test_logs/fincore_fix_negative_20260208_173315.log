CMD: node -e 
import pg from "pg";
const { Pool } = pg;

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

async function main() {
  console.log("DB_FIX_START");

  await pool.query(`SET search_path TO totem_test, public`);

  await pool.query(`
    CREATE UNIQUE INDEX IF NOT EXISTS uq_ledger_idempotency
    ON ledger_entries (wallet_id, reference_type, reference_id, direction)
  `);

  console.log("DB_FIX_DONE");
  await pool.end();
}

main().catch(e => {
  console.error(e.stack);
  process.exit(1);
});

DB_FIX_START
DB_FIX_DONE

CMD: node tests/financial_core_negative_runner.mjs
[DB] MODE: POSTGRES
NEGATIVE_TEST_START
NEGATIVE_TEST_PASS

